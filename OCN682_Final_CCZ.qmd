---
title: "OCN682 Final: CCZ Micronekton"
author: "SZR"
format:
  html:
    lightbox: true
    toc: true
    toc-location: right
    toc-title: "Contents"
    code-fold: true
---

### Load Libraries

```{r}
#| message: false

library(here)
library(tidyverse)
library(readr)
library(dplyr)
library(plotly)
library(ggplot2)
library(lubridate)
library(purrr)
library(wesanderson)
```

# Brief Introduction to Deep Sea Mining

<div id="mechCarousel" class="carousel slide" data-bs-ride="false" style="max-width: 600px; margin: 0 auto;">
<div class="carousel-inner">

<div class="carousel-item active">
<img src="https://eos.org/wp-content/uploads/2022/01/seafloor-nodules.jpg" class="d-block w-100">
</div>

<div class="carousel-item">
<img src="http://live.staticflickr.com/65535/51787012177_46b080e145_b.jpg" class="d-block w-100">
</div>

<div class="carousel-item">
<img src="https://deepseamining.ac/static/blog/img/CCZ%20License%20Blocks.webp" class="d-block w-100">
</div>

<div class="carousel-item">
<img src="https://inlandoceancoalition.org/wp-content/uploads/2024/01/drazen-et-al-1.jpg" 
     class="d-block mx-auto w-75">
</div>

</div>

<button class="carousel-control-prev" type="button" data-bs-target="#mechCarousel" data-bs-slide="prev">
<span class="carousel-control-prev-icon"></span>
</button>

<button class="carousel-control-next" type="button" data-bs-target="#mechCarousel" data-bs-slide="next">
<span class="carousel-control-next-icon"></span>
</button>

</div>


### About ccz_ltu data

The International Seabed Authority governs the CCZ and requires ecological assessments prior to the start of mining.

This gave my lab the opportunity to survey micronekton- small fish & invertebrates between 2-20cm- and establish the baseline community composition of midwater micronekton in the CCZ.

The **full ccz_ltu data set** includes the lowest taxonomic (LTU) recorded for all fish and invertebrates sampled from the Clarion Clipperton Zone (CCZ). 

Using this data, the question I would like to answer is: 

**How does the trophic ecology of micronekton provide evidence of connectivity between different depths in the water column?**

- Though my diet data is not quite ready to be processed, I can use the full ccz_micro data set to display the species I chose to subsample and why
    

Sampling:

- Micronekton were collected via **10m Multiple Opening and Closing Environmental Sensing System (MOCNESS)**
- Specimens were collected in the **spring** and **fall** of 2021
- Sampling locations were the **Preservation Reference Zone (PRZ)** and **Collection Test Area (CTA)** which exist at opposite corners of NORI-D

```{r}
#| echo: false
#| warning: false
#| message: false

ccz_ltu <- read.csv(here("Data/Micro_LTU.csv"))

ccz_ltu_filtered <- ccz_ltu %>% 
  mutate(
    depth_range_m = case_when( ## renaming net numbers as depth ranges
      Net.. == 1 ~ "1000-1500",
      Net.. == 2 ~ "700-1000",
      Net.. == 3 ~ "450-700",
      Net.. == 4 ~ "70-450",
      Net.. == 5 ~ "0-70",
      TRUE ~ NA_character_
    ),
    n.10.000.m3 = as.numeric(n.10.000.m3) ## changing n/10000m3 to be treated as a numeric
  ) %>% 
  filter(
    !Net.. %in% c(0, "4plus5"), ## removing the combined nets (MOCNESS failure)
    !(tolower(Tow.Type) %in% "deep"), ## removing deep tows
    Phylum.broader.classification == "Chordata", ## looking only at fish
    grepl("^[A-Za-z]+ [A-Za-z]+$", LTU), ## keeping only LTUs formatted as genus species
    !grepl("\\?|\\bsp\\.?\\b|Unknown", LTU, ignore.case = TRUE) ## removing IDs with uncertainty
  ) %>% 
  select( ## reordering the columns for better viewing
    Label, 
    Sample.., 
    n, 
    Family, 
    LTU, 
    Date, 
    Cruise.Number, 
    Site, 
    Tow.Type, 
    Tow.., 
    Net.., 
    depth_range_m, 
    Preservative, 
    ETP.Endemic., 
    n.10.000.m3
  )

```


Let's take a look at the total species presence at each depth range (not divided by site or season)

# Plotting abundance per species per depth

```{r}
#| echo: false
#| warning: false
#| message: false

ccz_depth_ltu <- ccz_ltu_filtered %>% 
  group_by(LTU, Family, depth_range_m) %>% ## grouping based on
  summarise(total_n = sum(n, na.rm = TRUE), .groups = "drop") %>% 
  mutate(
    depth_range_m = factor(
      depth_range_m,
      levels = c("0-70", "70-450", "450-700", "700-1000", "1000-1500")
    )
  )

fish_abundance <- plot_ly(data = ccz_depth_ltu,
                          x = ~total_n,
                          y = ~depth_range_m,
                          color = ~LTU,
                          type = "scatter", 
                          mode = "markers",     # points only
                          hoverinfo = "text",
                          text = ~paste(
                            "Species:", LTU,
                            "<br>Family:", Family,
                            "<br>n:", total_n)) %>%
  layout(
    yaxis = list(
      title = "Depth range (m)",
      autorange = "reversed"), ## reversing depth order so 0 is on top
    xaxis = list(
      title = "Total n (log scale)",
      type = "log" ## log transforming counts
    ),
    legend = list(title = list(text = "Species"))
  )

fish_abundance
```



This interactive plot provides a simple visual of the fish species present within each depth range. You can select/deselect species from the key to examine individual species! :D

I am interested in the **diets** of the **most abundant fishes**. 

While Cyclothone technically dominate in abundance, my focus is specifically on **non-cyclothone** micronekton since there are logistical errors in dissecting specimens from this taxonomic group.

The most abundant species chosen for gut content analysis include:

- *Diaphus pacificus*
- *Diogenichthys laternatus*
- *Vinciguerria lucetia*
- *Argyropelecus lychnus* 
- *Scopeloberyx malayanus*
- *Scopelogadus bispinosus*
- *Bathylagoides nigrigenys*
- *Idiacanthus antrostomus*
- *Lampanyctus parvicauda*
- *Scopelengys tristis*


Lets take a closer look at their migration behaviors divided by season with data from sites combined.


# Kite Diagrams of Targeted Species 

- Kite diagrams display changes in vertical distribution during day/night and highlight migration behaviors that are often associated with feeding

```{r}
#| echo: false
#| warning: false
#| message: false

target_species <- c(
  "Diaphus pacificus",
  "Diogenicthys laternatus",
  "Lampanyctus parvicauda", 
  "Scopeloberyx malayanus", 
  "Scopelogadus bispinosus", 
  "Argyropelecus lychnus", 
  "Bathylagoides nigrigenys", 
  "Vinciguerria lucetia", 
  "Idiacanthus antrostomus",
  "Scopelengys tristis"
)

kite_dat_combined <- ccz_ltu_filtered %>% 
  filter(LTU %in% target_species) %>% 
  mutate(
    # DG5B = Spring, DG5C = Fall
    Season = case_when(
      Cruise.Number == "DG5B" ~ "Spring",
      Cruise.Number == "DG5C" ~ "Fall",
      TRUE ~ NA_character_
    ),
    Tow.Type = if_else(grepl("day", Tow.Type, ignore.case = TRUE), "Day", "Night")
  ) %>% 
  group_by(LTU, Season, Tow.Type, depth_range_m) %>% 
  summarise(
    density = sum(n.10.000.m3, na.rm = TRUE),   # PRZ + CTA combined
    .groups = "drop"
  ) %>% 
  mutate(
    # exact bin edges
    depth_top = case_when(
      depth_range_m == "0-70"      ~   0,
      depth_range_m == "70-450"    ~  70,
      depth_range_m == "450-700"   ~ 450,
      depth_range_m == "700-1000"  ~ 700,
      depth_range_m == "1000-1500" ~ 1000,
      TRUE ~ NA_real_
    ),
    depth_bottom = case_when(
      depth_range_m == "0-70"      ~   70,
      depth_range_m == "70-450"    ~  450,
      depth_range_m == "450-700"   ~ 700,
      depth_range_m == "700-1000"  ~ 1000,
      depth_range_m == "1000-1500" ~ 1500,
      TRUE ~ NA_real_
    ),
    Season = factor(Season, levels = c("Spring", "Fall"))
  )

plot_kite_species_combined <- function(sp_name) {

  dat <- dplyr::filter(kite_dat_combined, LTU == sp_name) %>%
    mutate(Tow.Type = factor(Tow.Type, levels = c("Day", "Night")))

  pal <- c(
    "Day"   = "#A8D5BA",  # light soft green
    "Night" = "#146B67"   # deep teal green
  )

  ggplot(dat) +
    geom_rect(
      aes(
        xmin = if_else(Tow.Type == "Day", -density, 0),
        xmax = if_else(Tow.Type == "Day",  0,        density),
        ymin = depth_top,
        ymax = depth_bottom,
        fill = Tow.Type
      ),
      color = "grey20",
      alpha = 0.95
    ) +
    geom_vline(xintercept = 0, colour = "grey15", linewidth = 0.5) +
    scale_y_reverse(
      name   = "Depth (m)",
      limits = c(1500, 0),
      breaks = c(0, 70, 450, 700, 1000, 1500),
      expand = expansion(mult = c(0, 0))
    ) +
    scale_x_continuous(
      name   = "Density (n/10,000mÂ³)",
      breaks = scales::pretty_breaks(5),
      labels = abs
    ) +
    facet_grid(. ~ Season) +
    scale_fill_manual(values = pal, name = "Tow Type") +
    labs(
      title = sp_name
    ) +
    theme_minimal(base_size = 11) +
    theme(
      strip.background = element_rect(fill = "grey95", colour = NA),
      strip.text.x     = element_text(face = "bold"),

      panel.grid.major.x = element_blank(),
      panel.grid.minor   = element_blank(),
      panel.grid.major.y = element_line(colour = "grey85", linewidth = 0.3),

      axis.title.x = element_text(margin = margin(t = 6)),
      axis.title.y = element_text(margin = margin(r = 6)),

      legend.position = "bottom",
      legend.title    = element_text(face = "bold"),

      plot.title = element_text(face = "bold", hjust = 0.5, size = 13)
    )
}

dir.create("figs", showWarnings = FALSE)

file_names <- sprintf(
  "figs/kite_%s.png",
  gsub(" ", "_", target_species)
)

for (i in seq_along(target_species)) {
  sp <- target_species[i]
  fn <- file_names[i]
  p  <- plot_kite_species_combined(sp)

  ggsave(
    filename = fn,
    plot     = p,
    width    = 7,
    height   = 5,
    dpi      = 300
  )
}
```



<div id="kiteCarousel" class="carousel slide" data-bs-ride="false" style="max-width: 700px; margin: 0 auto;">
<div class="carousel-inner">

<div class="carousel-item active">
<img src="figs/kite_Diaphus_pacificus.png" class="d-block w-100">
</div>

<div class="carousel-item">
<img src="figs/kite_Diogenicthys_laternatus.png" class="d-block w-100">
</div>

<div class="carousel-item">
<img src="figs/kite_Lampanyctus_parvicauda.png" class="d-block w-100">
</div>

<div class="carousel-item">
<img src="figs/kite_Scopeloberyx_malayanus.png" class="d-block w-100">
</div>

<div class="carousel-item">
<img src="figs/kite_Scopelogadus_bispinosus.png" class="d-block w-100">
</div>

<div class="carousel-item">
<img src="figs/kite_Argyropelecus_lychnus.png" class="d-block w-100">
</div>

<div class="carousel-item">
<img src="figs/kite_Bathylagoides_nigrigenys.png" class="d-block w-100">
</div>

<div class="carousel-item">
<img src="figs/kite_Vinciguerria_lucetia.png" class="d-block w-100">
</div>

<div class="carousel-item">
<img src="figs/kite_Idiacanthus_antrostomus.png" class="d-block w-100">
</div>

<div class="carousel-item">
<img src="figs/kite_Scopelengys_tristis.png" class="d-block w-100">
</div>

</div>

<button class="carousel-control-prev" type="button" data-bs-target="#kiteCarousel" data-bs-slide="prev">
<span class="carousel-control-prev-icon"></span>
</button>

<button class="carousel-control-next" type="button" data-bs-target="#kiteCarousel" data-bs-slide="next">
<span class="carousel-control-next-icon"></span>
</button>

</div>

What does this show us?

- Micronekton can have different migration patterns (even within the same species during different seasons)
- We can categorize species based on migration
- Migration patterns can influence feeding behaviors
